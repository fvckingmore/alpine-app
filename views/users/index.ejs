<%-include('../layouts/head');%>


<div class="container mt-4" x-data="usuariosComponent()" x-init="usuariosComponent.init">

	<div x-cloak x-show="initVar" x-transition>
		<div class="d-flex justify-content-center">
			<div class="spinner-border" role="status">
				<span class="sr-only">Loading...</span>
			</div>
		</div>
	</div>

<div x-cloak x-show="!initVar" x-transition>
	
	<div class="row mx-auto my-auto justify-content-center">
		<div class="col-8">

			<%-include('./modal');%>
		</div>
	</div>

	<div class="row mx-auto my-2 justify-content-center">
		<div class="col-8 text-right">
			<button class="btn btn-primary" x-show="!modal" @click="openModal">+</button>
		</div>
	</div>

	<div class="row mx-auto my-auto justify-content-center">

		<div class="col-8">

			<div class="card">
				<div class="card-header text-center">
					<h4> Usuarios </h4>
				</div>
				<div class="card-body">

					<template x-if="users.length === 0">
						<h3 class="text-center">No hay registros</h3>
					</template>

					<template x-if="users.length !== 0">


					<table class="table text-center">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">Username</th>
								<th scope="col">Password</th>
								<th scope="col">Actions</th>
							</tr>
						</thead>
						<tbody>

							<template x-for="(u, index) in users">
								<tr>
									<th x-text="u.id" scope="row"></th>
									<td x-text="u.username"></td>
									<td x-text="u.password"></td>
									<td>
											<div class="btn-group" role="group" aria-label="Basic example">
												<button type="button" @click="editUser(index)" class="btn btn-success">Editar</button>
												<button type="button" @click="deleteUser(u.id)" class="btn btn-danger">Borrar</button>
											</div>
										</div>
									</td>
								</tr>
							</template>
							
						</tbody>
					</table>
				</template>

				</div>

				<div class="card-footer text-center">
					<div class="btn-group" role="group" aria-label="Basic example">
						<template x-if="page > 1">
							
							<button type="button" @click="prevPage" class="btn btn-primary">Prev</button>
						</template>
						<template x-if="page < (totalUsers/10)">
							<button type="button" @click="nextPage" class="btn btn-primary">Next</button>
						</template>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>

</div>

<%-include('../layouts/scripts');%>

<script type="text/javascript">

	function usuariosComponent() {
		return {
			users: [],
			totalUsers: "",
			page: "",
			limit: "",
			baseURL: "http://localhost:3000/user",
			modal: false,
			user: "",
			password: "",
			userId: "",
			initVar: true,
			edit: false,


			init: function() {
				axios.get(this.baseURL+"/get")
				.then(res => {
					this.users = res.data.users;
					this.totalUsers = res.data.totalUsers;
					this.limit = res.data.limit;
					this.page = res.data.page;
					this.user = "";
					this.password = "";
					this.userId = "";
					this.modal = false;
					this.initVar = false;
					this.edit = false;
				});
			},

			prevPage: function() {
				if(this.page > 1) {
					this.page--;
					axios.get(this.baseURL+"/get?page="+this.page)
					.then(res => this.users = res.data.users)
					.catch(e => console.log(e));
				}
			},

			nextPage: function() {
				if(this.page < (this.totalUsers/10)) {
					this.page++;
					axios.get(this.baseURL+"/get?page="+this.page)
					.then(res => this.users = res.data.users)
					.catch(e => console.log(e));
				}
			},

			deleteUser: function(id) {
				axios.post(this.baseURL+'/destroy', {
					id: id,
				})
				.then(res => this.init())
				.catch(e => console.log(e));
			},

			addUser: function() {
				if(this.edit) {
					axios.post(this.baseURL+'/update', {
						username: this.user,
						password: this.password,
						id: this.userId,
					})
					.then(res => this.init())
					.catch(e => console.log(e));
				} else {
					axios.post(this.baseURL+'/create', {
						username: this.user,
						password: this.password,
					})
					.then(res => this.init())
					.catch(e => console.log(e));
				}
			},

			editUser: function(index) {
				this.user = this.users[index].username;
				this.password = this.users[index].password;
				this.userId = this.users[index].id;
				this.edit = true;
				this.openModal();
			},

			openModal: function() {
				this.modal = ! this.modal;
			},

			closeModal: function() {
				this.modal = ! this.modal;
				this.user = "";
				this.password = "";
			},


		}
	}

</script>


<%-include('../layouts/foot');%>